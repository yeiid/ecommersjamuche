import"./supabase.CIJy6KaJ.js";document.addEventListener("DOMContentLoaded",()=>{const g=document.getElementById("delete-condition"),h=document.getElementById("condition-value-container"),p=document.getElementById("condition-value"),y=document.getElementById("bulk-field"),d=document.getElementById("bulk-value"),x=document.getElementById("btn-bulk-update"),I=document.getElementById("btn-bulk-delete"),C=document.getElementById("btn-import"),L=document.getElementById("btn-export"),f=document.getElementById("notification"),b=document.getElementById("preview-container"),s=JSON.parse(document.getElementById("productos-data")?.textContent||"[]"),B=JSON.parse(document.getElementById("especies-data")?.textContent||"[]"),N=["Aceites esenciales","Cuidado de piel","Infusiones","Aromaterapia","Productos capilares","Suplementos"];g&&g.addEventListener("change",()=>{if(!h||!p)return;p.innerHTML='<option value="">Seleccionar valor</option>';const n=g.value;if(!n){h.classList.add("hidden");return}h.classList.remove("hidden"),n==="category"?N.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,p.appendChild(t)}):n==="especie"?B.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.nombre,p.appendChild(t)}):n==="selected"?v(s):h.classList.add("hidden")}),y&&y.addEventListener("change",()=>{if(!d)return;const n=y.value;if(d.type="text",n==="isNew"||n==="featured")d.type="checkbox";else if(n==="especieid"){const e=document.createElement("select");e.id="bulk-value",e.className=d.className;const t=document.createElement("option");t.value="",t.textContent="Seleccionar especie",e.appendChild(t),B.forEach(o=>{const r=document.createElement("option");r.value=o.id,r.textContent=o.nombre,e.appendChild(r)}),d.parentNode.replaceChild(e,d)}});function v(n){if(!b)return;if(!n||n.length===0){b.innerHTML='<p class="text-gray-500 dark:text-gray-400 text-center">No hay productos seleccionados</p>';return}let e='<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';n.forEach(t=>{e+=`
          <div class="flex items-center border border-gray-200 dark:border-gray-600 p-3 rounded-md">
            <input type="checkbox" class="product-checkbox mr-3" value="${t.id}">
            <div class="flex-1">
              <h4 class="font-medium">${t.name}</h4>
              <p class="text-sm text-gray-500 dark:text-gray-400">
                ${t.category} - $${t.price.toLocaleString()} - Stock: ${t.stock||0}
              </p>
            </div>
          </div>
        `}),e+="</div>",b.innerHTML=e}function c(n,e=!0){f&&(f.textContent=n,f.className=e?"bg-green-100 dark:bg-green-900 border-l-4 border-green-500 text-green-700 dark:text-green-200 p-4 rounded-md mb-6":"bg-red-100 dark:bg-red-900 border-l-4 border-red-500 text-red-700 dark:text-red-200 p-4 rounded-md mb-6",f.classList.remove("hidden"),setTimeout(()=>{f.classList.add("hidden")},5e3))}x&&x.addEventListener("click",async()=>{const n=document.getElementById("bulk-category")?.value,e=y?.value;let t=d?.value;if(!n||!e||!t){c("Por favor complete todos los campos",!1);return}e==="stock"||e==="discountPrice"?t=parseInt(t)||0:(e==="isNew"||e==="featured")&&(t=d.checked);try{const o=s.filter(r=>r.category===n).map(r=>({id:r.id,[e]:t}));if(o.length===0){c("No hay productos en esta categoría para actualizar",!1);return}v(o.map(r=>({...s.find(a=>a.id===r.id),[e]:t}))),await bulkUpdateProducts(o),c(`${o.length} productos actualizados correctamente`)}catch(o){c(`Error: ${o.message}`,!1)}}),I&&I.addEventListener("click",async()=>{try{const n=g?.value;if(!n){c("Seleccione una condición para eliminar",!1);return}let e=[];if(n==="stock")e=s.filter(o=>!o.stock||o.stock===0);else if(n==="category"){const o=p?.value;if(!o){c("Seleccione una categoría",!1);return}e=s.filter(r=>r.category===o)}else if(n==="especie"){const o=p?.value;if(!o){c("Seleccione una especie",!1);return}e=s.filter(r=>r.especieid===o)}else if(n==="selected"){const o=document.querySelectorAll(".product-checkbox:checked");if(o.length===0){c("Seleccione al menos un producto",!1);return}const r=Array.from(o).map(l=>l.value);e=s.filter(l=>r.includes(l.id))}if(e.length===0){c("No hay productos que cumplan con la condición",!1);return}if(!confirm(`¿Está seguro de eliminar ${e.length} productos? Esta acción no se puede deshacer.`))return;const t=e.map(o=>o.id);await bulkDeleteProducts(t),c(`${t.length} productos eliminados correctamente`),v([])}catch(n){c(`Error: ${n.message}`,!1)}}),C&&C.addEventListener("click",async()=>{const e=document.getElementById("import-file")?.files?.[0];if(!e){c("Seleccione un archivo para importar",!1);return}try{const t=new FileReader;t.onload=async o=>{try{let r=[];if(e.name.endsWith(".csv")){const a=o.target.result.split(`
`),E=a[0].split(",");for(let m=1;m<a.length;m++){if(!a[m].trim())continue;const k=a[m].split(","),i={};E.forEach((u,S)=>{i[u.trim()]=k[S]?.trim()||"",["price","discountPrice","stock"].includes(u.trim())?i[u.trim()]=parseInt(i[u.trim()])||0:["isNew","featured"].includes(u.trim())&&(i[u.trim()]=i[u.trim()].toLowerCase()==="true")}),r.push(i)}}else e.name.endsWith(".json")&&(r=JSON.parse(o.target.result));if(r.length===0){c("No hay productos válidos para importar",!1);return}await bulkInsertProducts(r),c(`${r.length} productos importados correctamente`),v(r)}catch(r){c(`Error al procesar el archivo: ${r.message}`,!1)}},e.name.endsWith(".csv")||e.name.endsWith(".json")?t.readAsText(e):c("Formato de archivo no soportado. Use CSV o JSON",!1)}catch(t){c(`Error: ${t.message}`,!1)}}),L&&L.addEventListener("click",()=>{const n=document.getElementById("export-format")?.value||"csv";try{let e,t,o;if(n==="csv"){const E=Object.keys(s[0]||{}).join(","),m=s.map(k=>Object.values(k).map(i=>typeof i=="object"?`"${JSON.stringify(i).replace(/"/g,'""')}"`:`"${i}"`).join(","));e=[E,...m].join(`
`),t="productos.csv",o="text/csv"}else e=JSON.stringify(s,null,2),t="productos.json",o="application/json";const r=new Blob([e],{type:o}),l=URL.createObjectURL(r),a=document.createElement("a");a.href=l,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(l),c(`Exportación de ${s.length} productos completada`)}catch(e){c(`Error al exportar: ${e.message}`,!1)}})});
