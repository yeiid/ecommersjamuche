import{b as d,c as g,p as I}from"./client.schema.D9gTZs88.js";import{m as h,a as m}from"./index.9eZ28vGx.js";const o=h({}),C=m(0),v=m(0),i=m(null),p="jamuche-cart";let f=!1,u=!1;function T(t,e=1){try{const r=o.get(),a=t.quantity?t.quantity:e,n=r[t.id]?.quantity||0,c={...t};"quantity"in c&&delete c.quantity;const E=I(c,n+a);return o.setKey(t.id,E),s(),i.set(null),l(o.get()),!0}catch(r){return console.error("Error al añadir al carrito:",r),i.set(r.message||"Error al añadir producto al carrito"),!1}}function K(t,e){try{const a=o.get()[t];if(!a)throw new Error("Producto no encontrado en el carrito");if(e>0){const n={...a,quantity:e,total:g({...a,quantity:e})},c=d(n);o.setKey(t,c)}else b(t);return s(),i.set(null),l(o.get()),!0}catch(r){return console.error("Error al actualizar cantidad:",r),i.set(r.message||"Error al actualizar cantidad"),!1}}function b(t){try{const r=o.get()[t];if(!r)throw new Error("Producto no encontrado en el carrito");if(r.quantity>1){const a={...r,quantity:r.quantity-1,total:g({...r,quantity:r.quantity-1})},n=d(a);o.setKey(t,n)}else o.setKey(t,void 0);return s(),i.set(null),l(o.get()),!0}catch(e){return console.error("Error al eliminar del carrito:",e),i.set(e.message||"Error al eliminar del carrito"),!1}}function j(t){try{return o.setKey(t,void 0),s(),i.set(null),l(o.get()),!0}catch(e){return console.error("Error al eliminar completamente:",e),i.set(e.message||"Error al eliminar completamente"),!1}}function s(){const t=o.get();let e=0,r=0;Object.values(t).forEach(a=>{if(a){e+=a.quantity;const n=a.discountprice>0?a.discountprice:a.price;r+=n*a.quantity}}),C.set(e),v.set(r)}function l(t){if(!(typeof window>"u"||u))try{u=!0,localStorage.setItem(p,JSON.stringify(t))}catch(e){console.error("Error al guardar carrito en localStorage:",e)}finally{u=!1}}function y(){if(typeof window>"u")return{};try{const t=localStorage.getItem(p);if(!t)return{};const e=JSON.parse(t);return e&&typeof e=="object"?e:{}}catch(t){return console.error("Error al cargar carrito desde localStorage:",t),{}}}function w(){if(!(typeof window>"u"||f))try{f=!0;const t=y();t&&typeof t=="object"&&(o.set({}),Object.entries(t).forEach(([r,a])=>{if(a)try{const n=d(a);o.setKey(r,n)}catch(n){console.warn(`Item inválido en carrito guardado (ID: ${r}):`,n)}}),s());const e=o.listen(r=>{typeof window<"u"&&!u&&l(r)});window.__cartUnsubscribe=e,l(o.get()),window.addEventListener("focus",()=>{const r=y();r&&typeof r=="object"&&(Object.entries(r).forEach(([a,n])=>{if(n)try{o.setKey(a,d(n))}catch(c){console.warn(`Error al recargar item (ID: ${a}):`,c)}}),s())})}catch(t){console.error("Error al inicializar carrito:",t),o.set({}),s()}}function O(){return typeof window<"u"&&!f?(w(),!0):f}typeof window<"u"&&setTimeout(()=>{w()},50);export{v as a,i as b,o as c,j as d,O as e,T as f,C as g,b as r,K as u};
