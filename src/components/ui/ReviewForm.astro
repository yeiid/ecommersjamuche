---
// Formulario para enviar reseñas de productos
interface Props {
  productId: string;
}

const { productId } = Astro.props;
---

<div class="review-form bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
  <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">
    Escribe una reseña
  </h3>

  <form id="review-form">
    <input type="hidden" name="productId" value={productId} />

    <div class="mb-4">
      <label
        for="author"
        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
        >Nombre</label
      >
      <input
        type="text"
        id="author"
        name="author"
        required
        class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500"
      />
    </div>

    <div class="mb-4">
      <label
        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
        >Calificación</label
      >
      <div class="flex items-center space-x-1" id="rating-stars">
        <button
          type="button"
          class="rating-star text-gray-300 dark:text-gray-600 hover:text-yellow-400"
          data-rating="1"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
            ></path>
          </svg>
        </button>
        <button
          type="button"
          class="rating-star text-gray-300 dark:text-gray-600 hover:text-yellow-400"
          data-rating="2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
            ></path>
          </svg>
        </button>
        <button
          type="button"
          class="rating-star text-gray-300 dark:text-gray-600 hover:text-yellow-400"
          data-rating="3"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
            ></path>
          </svg>
        </button>
        <button
          type="button"
          class="rating-star text-gray-300 dark:text-gray-600 hover:text-yellow-400"
          data-rating="4"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
            ></path>
          </svg>
        </button>
        <button
          type="button"
          class="rating-star text-gray-300 dark:text-gray-600 hover:text-yellow-400"
          data-rating="5"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
            ></path>
          </svg>
        </button>
      </div>
      <input type="hidden" id="rating" name="rating" value="0" required />
    </div>

    <div class="mb-4">
      <label
        for="comment"
        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
        >Comentario</label
      >
      <textarea
        id="comment"
        name="comment"
        rows="4"
        required
        class="w-full px-4 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500"
      ></textarea>
    </div>

    <div class="flex justify-end">
      <button
        type="submit"
        id="submit-review"
        class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
      >
        Enviar reseña
      </button>
    </div>
  </form>

  <div id="review-success" class="hidden mt-4">
    <div
      class="p-4 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-md"
    >
      ¡Gracias por tu reseña! Tu comentario ha sido enviado correctamente.
    </div>
  </div>

  <div id="review-error" class="hidden mt-4">
    <div
      class="p-4 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-md"
    >
      Ha ocurrido un error al enviar tu reseña. Por favor, intenta nuevamente.
    </div>
  </div>
</div>

<script>
  import { addReview } from "../../stores/reviewsStore";

  document.addEventListener("DOMContentLoaded", () => {
    const reviewForm = document.getElementById("review-form");
    const ratingStars = document.querySelectorAll(".rating-star");
    const ratingInput = document.getElementById("rating") as HTMLInputElement;
    const reviewSuccess = document.getElementById("review-success");
    const reviewError = document.getElementById("review-error");

    // Manejo de estrellas de calificación
    ratingStars.forEach((star) => {
      star.addEventListener("click", (e) => {
        const clickedStar = e.currentTarget as HTMLElement;
        const rating = parseInt(
          clickedStar.getAttribute("data-rating") || "0",
          10
        );

        // Actualizar valor oculto
        if (ratingInput) ratingInput.value = rating.toString();

        // Actualizar visualización de estrellas
        ratingStars.forEach((s) => {
          const starElement = s as HTMLElement;
          const starRating = parseInt(
            starElement.getAttribute("data-rating") || "0",
            10
          );

          if (starRating <= rating) {
            starElement.classList.add("text-yellow-400");
            starElement.classList.remove("text-gray-300", "dark:text-gray-600");
          } else {
            starElement.classList.remove("text-yellow-400");
            starElement.classList.add("text-gray-300", "dark:text-gray-600");
          }
        });
      });
    });

    // Envío del formulario
    if (reviewForm) {
      reviewForm.addEventListener("submit", (e) => {
        e.preventDefault();

        // Obtener valores del formulario
        const formData = new FormData(reviewForm as HTMLFormElement);
        const author = formData.get("author") as string;
        const rating = parseInt(formData.get("rating") as string, 10);
        const comment = formData.get("comment") as string;
        const productId = formData.get("productId") as string;

        // Validar
        if (!author || !comment || rating < 1 || !productId) {
          if (reviewError) reviewError.classList.remove("hidden");
          setTimeout(() => {
            if (reviewError) reviewError.classList.add("hidden");
          }, 3000);
          return;
        }

        // Añadir reseña
        try {
          addReview({
            productId,
            author,
            rating,
            comment,
          });

          // Mostrar mensaje de éxito
          if (reviewSuccess) reviewSuccess.classList.remove("hidden");

          // Reiniciar formulario
          (reviewForm as HTMLFormElement).reset();

          // Reiniciar estrellas
          ratingStars.forEach((s) => {
            s.classList.remove("text-yellow-400");
            s.classList.add("text-gray-300", "dark:text-gray-600");
          });
          if (ratingInput) ratingInput.value = "0";

          // Ocultar mensaje después de un tiempo
          setTimeout(() => {
            if (reviewSuccess) reviewSuccess.classList.add("hidden");
            // Recargar la página para mostrar la nueva reseña
            window.location.reload();
          }, 3000);
        } catch (error) {
          console.error("Error al añadir reseña:", error);
          if (reviewError) reviewError.classList.remove("hidden");
          setTimeout(() => {
            if (reviewError) reviewError.classList.add("hidden");
          }, 3000);
        }
      });
    }
  });
</script>

